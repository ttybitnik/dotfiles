#!/bin/sh

# Cron/timer script to automate the exportation from Calibre to BiBTeX.
#   Globals:
#     TTY_PROMETHEUS
#   Dependencies:
#     /usr/local/lib/tty.sh

. /usr/local/lib/tty.sh

readonly BIBFILE="${TTY_PROMETHEUS}/bibliography/general.bib"
readonly CALIBREGUI_PID="GUIPool"

calibretobib () {
    if ! tty_run_print calibredb catalog "$BIBFILE"
    then
	tty_notify_fatal "%s: calibredb catalog failed with exit code %d" \
			 "$(basename "$0")" "$?"
    fi

    # OPT(sed): i=in-place
    if ! tty_run_print sed -i 's/{"}/\\"/g' "$BIBFILE"
    then
	tty_notify_fatal "%s: sed failed with exit code %d" \
			 "$(basename "$0")" "$?"
    fi
}

# OPT(pgrep): x=exact
if pgrep -x "$CALIBREGUI_PID" > /dev/null; then
    # OPT(pkill): x=exact
    pkill -x "$CALIBREGUI_PID"
    sleep 3
    calibretobib
else
    calibretobib
fi
