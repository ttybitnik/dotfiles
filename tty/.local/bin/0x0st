#!/usr/bin/env bash

# Share ephemeral files and snippets through <https://0x0.st>.
#   Dependencies:
#     /usr/local/lib/tty.sh
#     ~/.local/bin/ttylog

source /usr/local/lib/tty.sh

readonly SCRIPT="${0##*/}"

if [[ ! -f "$1" ]]; then
    tty_fatal "%s: invalid file '%s': must be existing regular file" \
	      "$SCRIPT" "$1"
fi

if [[ -n "$2" ]]; then
    if [[ "$2" =~ ^[1-9][0-9]{0,2}$ ]]; then
	expiration="${2}"
    else
	tty_fatal "%s: invalid expiration '%s': must be 1-3 digit integer" \
		  "$SCRIPT" "$2"
    fi
else
    expiration=24
fi

# OPT(curl): A=user-agent i=show-headers F=form
cmd=(
    "curl"
    "-A" "curl"
    "-i"
    "-F" "file=@${1}"
    "-F" "expires=$expiration"
    "https://0x0.st"
)

printf "+"
printf " %s" "${cmd[@]}"
printf "\n"
# OPT(read): r=no-backslashes p=prompt
read -rp "Run the command above and share $1 for ${expiration}h? [y/N]: " confirm

if [[ "$confirm" =~ ^[Yy]([Ee][Ss])?$ ]]; then
    ttylog "${cmd[@]}"
fi
