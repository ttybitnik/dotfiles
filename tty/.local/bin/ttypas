#!/bin/sh

# Script for handling APIs and secrets in a encrypted fashion.
#   Dependencies:
#     /usr/local/lib/tty.sh
#     ~/.ttypas2.gpg for setting secrets info
#   Structure:
#     service secret_path

. /usr/local/lib/tty.sh

readonly PASS_FILENAME="${HOME}/.ttypas2.gpg"

validate() {
    if [ ! -f "$PASS_FILENAME" ]; then
	tty_fatal "%s: file not found: '%s'" "$(basename "$0")" "$PASS_FILENAME"
    fi

    if [ "$#" -ne 1 ]; then
	tty_usage "%s <service>" "$(basename "$0")"
    fi
}

access() {
    pass_service="$1"
    # OPT(gpg): d=decrypt
    pass_info=$(gpg -d "$PASS_FILENAME" | grep "^$pass_service")

    if [ -z "$pass_info" ]; then
	tty_fatal "%s: service not found: '%s'" \
		  "$(basename "$0")" "$pass_service"
    fi

    pass_gpg=$(printf "%s" "$pass_info" | awk '{print $2}')
    # OPT(gpg): d=decrypt
    if ! gpg -d "$pass_gpg"
    then
	tty_fatal "%s: gpg failed with exit code %d" "$(basename "$0")" "$?"
    fi

    tty_notify_error "%s: %s password accesssed" \
		     "$(basename "$0")" "$(basename "$1")"
}

validate "$@"
access "$@"
