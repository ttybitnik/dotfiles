#!/bin/sh

# Rename file to its SHA256 digest with desired char length (default 16).
#   Installation:
#     system-wide (rerun 'make install' to reflect changes)
#   Dependencies:
#     /usr/local/lib/tty.sh

. /usr/local/lib/tty.sh

if [ "$#" -lt 1 ] || [ "$#" -gt 2 ]; then
    tty_usage "%s <filename> [char_length]" "$(basename "$0")"
fi

file="$1"
char_len="${2:-16}"

file_base="${file%.*}"
file_extension="${file##*.}"

# OPT(awk): v=var
file_sha=$(sha256sum "$file" | awk -v len="$char_len" \
				   '{print substr($1, 1, len)}')
new_filename="${file_base}-${file_sha}.${file_extension}"

if expr "$file_base" : ".*-[a-fA-F0-9]\{$char_len\}$" >/dev/null; then
    tty_fatal "%s: file already named with SHA256 digest: '%s'" \
	      "$(basename "$0")" "$file"
fi

# OPT(mv): v=verbose
mv -v "$file" "$new_filename"
