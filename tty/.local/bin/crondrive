#!/bin/sh

# Cron/timer script to sync changes between remote and local directories.
#   Globals:
#     TTY_ORPHEUS
#     TTY_PROMETHEUS
#   Dependencies:
#     /usr/local/lib/tty.sh

. /usr/local/lib/tty.sh

for drive in prometheus orpheus; do
    case $drive in
	prometheus) dir="${TTY_PROMETHEUS}/" ;;
	orpheus) dir="${TTY_ORPHEUS}/" ;;
	*) tty_fatal "%s: unknown drive: '%s'" "$(basename "$0")" "$drive" ;;
    esac

    if [ ! -d "$dir" ]; then
	tty_fatal "%s: directory not found: '%s'" \
		  "$(basename "$0")" "$dir"
    fi

    # OPT(rclone): v=verbose
    if ! tty_run_print rclone sync "$dir" "${drive}:" -v \
	 --skip-links --exclude ".git/"
    then
	tty_notify_fatal "%s: rclone sync failed for '%s' with exit code %d" \
			 "$(basename "$0")" "$drive" "$?"
    fi
done
