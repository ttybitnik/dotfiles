#!/bin/sh

# Cron/timer script to sync changes between remote and local directories.
#   Globals:
#     TTY_ARGO
#     TTY_ORPHEUS
#     TTY_PROMETHEUS
#   Dependencies:
#     /usr/local/lib/tty.sh

. /usr/local/lib/tty.sh

readonly SCRIPT="${0##*/}"

for drive in argo prometheus orpheus; do
    case $drive in
	argo) dir="${TTY_ARGO}/" ;;
	prometheus) dir="${TTY_PROMETHEUS}/" ;;
	orpheus) dir="${TTY_ORPHEUS}/" ;;
	*) tty_fatal "%s: unknown drive: '%s'" "$SCRIPT" "$drive" ;;
    esac

    if [ ! -d "$dir" ]; then
	tty_fatal "%s: directory not found: '%s'" "$SCRIPT" "$dir"
    fi

    # TODO: Add health check using check to validate remote files.
    # OPT(rclone): v=verbose
    if ! tty_run_print rclone sync "$dir" "${drive}:" -v \
	 --skip-links --exclude ".git/" "$1" "$2"
    then
	tty_notify_fatal "%s: rclone sync failed for '%s'" "$SCRIPT" "$drive"
    fi
done
