#!/bin/sh

# Cron/timer script to commit/update changes from local git repos.
#   Globals:
#     TTY_ORPHEUS
#   Dependencies:
#     /usr/local/lib/tty.sh

. /usr/local/lib/tty.sh

set -- \
    "${TTY_ORPHEUS}/gnu-emacs/org/" \
    "${TTY_ORPHEUS}/gnu-emacs/org-roam/"

for dir in "$@"; do
    if ! cd "$dir"
    then
	tty_fatal "%s: cannot change to directory '%s'" \
		  "$(basename "$0")" "$dir"
    fi

    if [ -z "$(git status --porcelain)" ]; then
	tty_info "%s: git working tree clean: nothing to commit" \
		 "$(basename "$0")"
	continue
    else
	# OPT(git): A=all
	if ! tty_run_print git add -A
	then
	    tty_fatal "%s: git add failed with exit code %d" \
		      "$(basename "$0")" "$?"
	fi

	# OPT(git): m=message
	if ! tty_run_print git commit -m "Update on $(LANG=C date)"
	then
	    tty_fatal "%s: git commit failed with exit code %d" \
		      "$(basename "$0")" "$?"
	fi
    fi
done
